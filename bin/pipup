#!/usr/bin/env python3

import subprocess
import re
import sys


def main():
    subprocess.check_call( "pip install --upgrade pip".split(), stderr=subprocess.STDOUT )
    pipscrape = subprocess.check_output( ['pip', 'freeze'], stderr=subprocess.STDOUT ).decode( 'utf-8' ).strip().split( '\n' )
    errors = []
    pips = []
    [ pips.append(p) if re.match( '^\S+==\S+', p ) else errors.append(p) for p in pipscrape ]
    if errors:
        # print( 'PIPS:' )
        # print( '\n'.join(pips) )
        print( 'ERRORS:' )
        print( '\n'.join(errors) )
    if not errors or '--force' in sys.argv:
        for p in pips:
            pipname = p.split( '==' )[0]
            pipupgrade_cmd = [ 'pip', 'install', '--upgrade', pipname ]
            try:
                print( ' '.join(pipupgrade_cmd) )
                print( subprocess.check_output( pipupgrade_cmd ).decode( 'utf-8' ) )
            except subprocess.CalledProcessError as e:
                print( e.output.decode('utf-8') )
                return -1


if __name__ == '__main__':
    sys.exit( main() )
